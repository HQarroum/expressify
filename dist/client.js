!function(e,t){if("function"==typeof define&&define.amd)define(["./request","./response","./event","timed-cache"],t);else if("undefined"!=typeof module&&module.exports)module.exports=t(require("./request"),require("./response"),require("./event"),require("timed-cache"));else{var n=this,r=t(n.Request,n.Response,n.Event,n.Cache),s=n[e];r.noConflict=function(){return n[e]=s,r},n[e]=r}}("ExpressifyClient",function(e,t,n,r){var s=function(e){throw new Error(e)},o=function(e){var t=e.cache.get(e.url);if(t)return t;var n=new Promise(function(t){var n=document.createElement("iframe");n.onload=function(){e.connection.addEventListener("message",function(r){e.connection.removeEventListener("message",arguments.callee),"__expressify"===r.data.resource&&!0===r.data.payload.online&&t(n)})},n.style.display="none",n.src=e.url,document.body.appendChild(n)});return e.cache.put(e.url,n,{ttl:1e7}),n},i=function(e){var n=this.cache.get(e.data.transactionId);n&&n(t.fromEvent(this,e))},c=function(e){var t=n.from(e),r=this.subscribers[t.resource];r&&r[t.subscriptionId]&&r[t.subscriptionId].callback(t)},u=function(e){try{"response"===e.data.type?i.call(this,e):"event"===e.data.type&&c.call(this,e)}catch(e){console.log(e.stack)}},a=function(e){this.opts=e||{},this.subscribers={},this.url=this.opts.url||s("An URL to an endpoint is required"),this.onMessage=u.bind(this),this.cache=new r({defaultTtl:e.timeout||1e4}),this.connection=this.opts.connection||window,this.connection.addEventListener("message",this.onMessage)};return a.prototype.request=function(t){var n=this;t.opts=t.opts||{};var r=new e({method:t.method,resource:t.url,payload:t.opts.data,headers:t.opts.headers});return o(this).then(function(e){return new Promise(function(s,o){n.cache.put(r.transactionId,function(e){return s(e)},{callback:function(){return o(new Error("Request timed out"))}});try{e.contentWindow.postMessage(r,t.opts.domain||"*")}catch(e){return o(e)}})})},a.prototype.subscribe=function(e,t){var n=this;return this.post("/subscription",{data:{resource:e}}).then(function(r){var s=r.payload.id;return 200===r.code?(n.subscribers[e]||(n.subscribers[e]={}),n.subscribers[e][s]||(n.subscribers[e][s]={callback:t}),Promise.resolve(r)):Promise.reject(r)})},["get","post","patch","put","head","delete","options"].forEach(function(e){a.prototype[e]=function(t,n){return this.request({method:e,url:t,opts:n})}}),a});