!function(e,t){if("function"==typeof define&&define.amd)define("request",["lodash","Joi"],t);else if("undefined"!=typeof module&&module.exports)module.exports=t(require("lodash"),require("joi"));else{var r=this,n=t(r._,r.Joi),i=r[e];n.noConflict=function(){return r[e]=i,n},r[e]=n}}("ExpressifyRequest",function(e,t){var r=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},n=function(e){return new URL(e,"http://placeholder").pathname},i=function(e){var t={},r=new URL(e,"http://placeholder"),n=!0,i=!1,o=void 0;try{for(var s,a,u=r.searchParams[Symbol.iterator]();!(n=(s=u.next()).done);n=!0)a=s.value,t[a[0]]=a[1]}catch(e){i=!0,o=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw o}}return t},o=t.object().keys({resource:t.string().required(),method:t.string().required(),payload:t.any().required(),transactionId:t.string().required(),headers:t.object().required(),caller:t.object().required(),type:t.string().required(),origin:t.string().optional(),query:t.object().required()}).unknown().required(),s={emitter:"__expressify_client",protocol:"expressify",version:"1.0.0"},a=function(e,a){1===arguments.length&&(a=e),this.app=e||{},this.event=a.event||{},this.caller=a.caller||s,this.resource=n(a.resource),this.method=a.method,this.payload=a.payload||{},this.headers=a.headers||{},this.origin=a.origin,this.transactionId=a.transactionId||r(),this.query=a.query||i(a.resource),this.type="request",this.set("User-Agent",s.emitter+"/"+s.version),t.validate(this,o,function(e){if(e)throw new Error(e)})};return a.from=function(e,t){return new a(e,{event:t,method:t.data.method,resource:t.data.resource,headers:t.data.headers,payload:t.data.payload,caller:t.data.caller,transactionId:t.data.transactionId,origin:t.origin,query:t.data.query})},a.prototype.set=function(e,t){return this.headers[e]=t,this},a.prototype.get=function(e){return this.headers[e]},a.prototype.serialize=function(){return e.pick(this,e.map(o._inner.children,function(e){return e.key}))},a}),function(e,t){if("function"==typeof define&&define.amd)define("response",["lodash","Joi"],t);else if("undefined"!=typeof module&&module.exports)module.exports=t(require("lodash"),require("Joi"));else{var r=this,n=t(r._,r.Joi),i=r[e];n.noConflict=function(){return r[e]=i,n},r[e]=n}}("ExpressifyResponse",function(e,t){var r={emitter:"__expressify_server",protocol:"expressify",version:"1.0.0"},n=t.object().keys({code:t.number().required(),transactionId:t.string().required(),headers:t.object().required(),payload:t.any().required(),caller:t.object().required(),type:t.string().required(),origin:t.string().optional()}).unknown().required(),i=function(e,i){this.app=e||{},this.caller=i.caller||r,this.code=i.code,this.headers=i.headers||{},this.payload=i.payload||{},this.req=i.req,this.origin=i.origin,this.type="response",this.transactionId=i.transactionId,t.validate(this,n,function(e){if(e)throw new Error(e)})};return i.fromEvent=function(e,t){return new i(e,{app:e,code:t.data.code,headers:t.data.headers,payload:t.data.payload,transactionId:t.data.transactionId,caller:t.data.caller,origin:t.origin})},i.fromRequest=function(e,t){return new i(e,{app:e,code:200,transactionId:t.data.transactionId,req:t})},i.prototype.set=function(e,t){return this.headers[e]=t,this},i.prototype.statusCode=function(e){return this.code=e,this},i.prototype.serialize=function(){return e.pick(this,e.map(n._inner.children,function(e){return e.key}))},i.prototype.send=function(t,n){this.req&&(e.isObject(t)?n=t:this.code=t,n&&(this.payload=n),this.set("Server",r.emitter+"/"+r.version),this.req.source.postMessage(this.serialize(),"*"))},i}),function(e,t){if("function"==typeof define&&define.amd)define("event",["lodash","Joi"],t);else if("undefined"!=typeof module&&module.exports)module.exports=t(require("lodash"),require("joi"));else{var r=this,n=t(r._,r.Joi),i=r[e];n.noConflict=function(){return r[e]=i,n},r[e]=n}}("ExpressifyEvent",function(e,t){var r=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},n=t.object().keys({resource:t.string().required(),payload:t.any().required(),transactionId:t.string().required(),caller:t.object().required(),type:t.string().required(),origin:t.string().optional()}).unknown().required(),i={emitter:"__expressify_emitter",protocol:"expressify",version:"1.0.0"},o=function(e){this.event=e.event||{},this.caller=e.caller||i,this.resource=e.resource,this.payload=e.payload||{},this.origin=e.origin,this.transactionId=e.transactionId||r(),this.subscriptionId=e.subscriptionId,this.type="event",t.validate(this,n,function(e){if(e)throw new Error(e)})};return o.from=function(e){return new o({event:e,resource:e.data.resource,payload:e.data.payload,caller:e.data.caller,transactionId:e.data.transactionId,subscriptionId:e.data.subscriptionId,origin:e.origin})},o.prototype.serialize=function(){return e.pick(this,e.map(n._inner.children,function(e){return e.key}))},o}),function(e,t){if("function"==typeof define&&define.amd)define("client",["./request","./response","./event","timed-cache"],t);else if("undefined"!=typeof module&&module.exports)module.exports=t(require("./request"),require("./response"),require("./event"),require("timed-cache"));else{var r=this,n=t(r.Request,r.Response,r.Event,r.Cache),i=r[e];n.noConflict=function(){return r[e]=i,n},r[e]=n}}("ExpressifyClient",function(e,t,r,n){var i=function(e){throw new Error(e)},o=function(e){var t=e.cache.get(e.url);if(t)return t;var r=new Promise(function(t){var r=document.createElement("iframe");r.onload=function(){e.connection.addEventListener("message",function(n){e.connection.removeEventListener("message",arguments.callee),"__expressify"===n.data.resource&&!0===n.data.payload.online&&t(r)})},r.style.display="none",r.src=e.url,document.body.appendChild(r)});return e.cache.put(e.url,r,{ttl:1e7}),r},s=function(e){var r=this.cache.get(e.data.transactionId);r&&r(t.fromEvent(this,e))},a=function(e){var t=r.from(e),n=this.subscribers[t.resource];n&&n[t.subscriptionId]&&n[t.subscriptionId].callback(t)},u=function(e){try{"response"===e.data.type?s.call(this,e):"event"===e.data.type&&a.call(this,e)}catch(e){console.log(e.stack)}},c=function(e){this.opts=e||{},this.subscribers={},this.url=this.opts.url||i("An URL to an endpoint is required"),this.onMessage=u.bind(this),this.cache=new n({defaultTtl:e.timeout||1e4}),this.connection=this.opts.connection||window,this.connection.addEventListener("message",this.onMessage)};return c.prototype.request=function(t){var r=this;t.opts=t.opts||{};var n=new e({method:t.method,resource:t.url,payload:t.opts.data,headers:t.opts.headers});return o(this).then(function(e){return new Promise(function(i,o){r.cache.put(n.transactionId,function(e){return i(e)},{callback:function(){return o(new Error("Request timed out"))}});try{e.contentWindow.postMessage(n,t.opts.domain||"*")}catch(e){return o(e)}})})},c.prototype.subscribe=function(e,t){var r=this;return this.post("/subscription",{data:{resource:e}}).then(function(n){var i=n.payload.id;return 200===n.code?(r.subscribers[e]||(r.subscribers[e]={}),r.subscribers[e][i]||(r.subscribers[e][i]={callback:t}),Promise.resolve(n)):Promise.reject(n)})},["get","post","patch","put","head","delete","options"].forEach(function(e){c.prototype[e]=function(t,r){return this.request({method:e,url:t,opts:r})}}),c});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e,t){if("function"==typeof define&&define.amd)define("path-to-regexp",t);else if("undefined"!=typeof module&&module.exports)module.exports=t();else{var r=this,n=t(),i=r[e];n.noConflict=function(){return r[e]=i,n},r[e]=n}}("pathToRegexp",function(){function e(e,n){for(var i,o=[],s=0,a=0,u="",c=n&&n.delimiter||"/";null!=(i=p.exec(e));){var d=i[0],f=i[1],l=i.index;if(u+=e.slice(a,l),a=l+d.length,f)u+=f[1];else{var h=e[a],y=i[2],m=i[3],g=i[4],v=i[5],b=i[6],q=i[7];u&&(o.push(u),u="");var x=i[2]||c,w=g||v;o.push({name:m||s++,prefix:y||"",delimiter:x,optional:"?"===b||"*"===b,repeat:"+"===b||"*"===b,partial:null!=y&&null!=h&&h!==y,asterisk:!!q,pattern:w?r(w):q?".*":"[^"+t(x)+"]+?"})}}return a<e.length&&(u+=e.substr(a)),u&&o.push(u),o}function t(e){return e.replace(/([.+*?=^!:${}()[\]|\/\\])/g,"\\$1")}function r(e){return e.replace(/([=!:$\/()])/g,"\\$1")}function n(e,t){return e.keys=t,e}function i(e){return e.sensitive?"":"i"}function o(e,t){var r=e.source.match(/\((?!\?)/g);if(r)for(var i=0;i<r.length;i++)t.push({name:i,prefix:null,delimiter:null,optional:!1,repeat:!1,partial:!1,asterisk:!1,pattern:null});return n(e,t)}function s(e,t,r){for(var o=[],s=0;s<e.length;s++)o.push(c(e[s],t,r).source);var a=new RegExp("(?:"+o.join("|")+")",i(r));return n(a,t)}function a(t,r,n){return u(e(t,n),r,n)}function u(e,r,o){isarray(r)||(o=r||o,r=[]),o=o||{};for(var s,a=o.strict,u=!1!==o.end,c="",d=0;d<e.length;d++)if(s=e[d],"string"==typeof s)c+=t(s);else{var p=t(s.prefix),f="(?:"+s.pattern+")";r.push(s),s.repeat&&(f+="(?:"+p+f+")*"),f=s.optional?s.partial?p+"("+f+")?":"(?:"+p+"("+f+"))?":p+"("+f+")",c+=f}var l=t(o.delimiter||"/"),h=c.slice(-l.length)===l;return a||(c=(h?c.slice(0,-l.length):c)+"(?:"+l+"(?=$))?"),c+=u?"$":a&&h?"":"(?="+l+"|$)",n(new RegExp("^"+c,i(o)),r)}function c(e,t,r){return isarray(t)||(r=t||r,t=[]),r=r||{},e instanceof RegExp?o(e,t):isarray(e)?s(e,t,r):a(e,t,r)}var d={}.toString;window.isarray=Array.isArray||function(e){return"[object Array]"==d.call(e)};var p=new RegExp("(\\\\.)|([\\/.])?(?:(?:\\:(\\w+)(?:\\(((?:\\\\.|[^\\\\()])+)\\))?|\\(((?:\\\\.|[^\\\\()])+)\\))([+*?])?|(\\*))","g");return c});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e,t){if("function"==typeof define&&define.amd)define("resource-manager",["./path-to-regexp"],t);else if("undefined"!=typeof module&&module.exports)module.exports=t(require("./path-to-regexp"));else{var r=this,n=t(r.pathToRegexp),i=r[e];n.noConflict=function(){return r[e]=i,n},r[e]=n}}("ExpressifyResourceManager",function(e){var t=function(e){for(var t=[],r=1,n=0;r<e.length;++r)":"===e[r][0]&&(t[n++]=e[r].substr(1));return t},r=function(){this.resources={}};return r.prototype.describe=function(){return this.resources},r.prototype.add=function(r,n,i){"object"!==_typeof(this.resources[r])&&(this.resources[r]={},this.resources[r].params={}),this.resources[r][n]={},i&&i.description&&(this.resources[r][n].description=i.description),this.resources[r].params=t(e(r).exec(r))},r.prototype.get=function(e){return this.resources[e]},r}),function(e,t){if("function"==typeof define&&define.amd)define("server",["middleware-chain","./request","./response","./event","./resource-manager","./path-to-regexp"],t);else if("undefined"!=typeof module&&module.exports)module.exports=t(require("middleware-chain-js"),require("./request"),require("./response"),require("./event"),require("./resource-manager"),require("./path-to-regexp"));else{var r=this,n=t(r.Chain,r.ExpressifyRequest,r.ExpressifyResponse,r.ExpressifyEvent,r.ExpressifyResourceManager,r.pathToRegexp),i=r[e];n.noConflict=function(){return r[e]=i,n},r[e]=n}}("ExpressifyServer",function(e,t,r,n,i,o){var s=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},a=function(e){try{"request"===e.data.type&&this.handle(t.from(this,e),r.fromRequest(this,e))}catch(e){console.log(e.stack)}},u=function(e,t){var r=e.payload.resource,n=s();this.subscribers[r]||(this.subscribers[r]={}),this.subscribers[r][n]||(this.subscribers[r][n]={connection:e.event.source}),t.send(200,{topic:r,id:n})},c=function(t){e.call(this),this.opts=t||{},this.subscribers={},this.resource=new i,this.onMessage=a.bind(this),this.onSubscribe=u.bind(this),this.connection=this.opts.connection||window,this.get("/description",function(e,t){t.send(200,e.app.resource.describe())}).post("/subscription",this.onSubscribe)};return c.prototype=Object.create(e.prototype),c.prototype.register=function(e,t,r,n){return this.resource.add(t,e,n),this.use(function(n,i,s){var a=this.resource.get(t),u=o(t).exec(n.resource),c=!!a&&n.method===e&&!!u;return c?(n.params=function(){return u.slice(1).reduce(function(e,t,r){return a.params[r]&&(e[a.params[r]]=t),e},{})}(),r(n,i,s)):void s()}.bind(this)),this},["get","post","patch","put","head","delete","options"].forEach(function(e){c.prototype[e]=function(t,r,n){return this.register(e,t,r,n)}}),c.prototype.publish=function(e,t){var r=this;Object.keys(this.subscribers[e]||[]).forEach(function(i){r.subscribers[e][i].connection.postMessage(new n({resource:e,payload:t,subscriptionId:i}),"*")})},c.prototype.listen=function(){this.listening||(this.connection.addEventListener("message",this.onMessage),this.listening=!0,parent&&parent.postMessage(new n({resource:"__expressify",payload:{online:!0}}).serialize(),"*"))},c.prototype.close=function(){this.listening&&(this.connection.removeEventListener("message",this.onMessage),this.listening=!1)},c}),function(e,t){if("function"==typeof define&&define.amd)define("expressify",["./client","./server"],t);else if("undefined"!=typeof module&&module.exports)module.exports=t(require("./client"),require("./server"));else{var r=this,n=t(r.ExpressifyClient,r.ExpressifyServer),i=r[e];n.noConflict=function(){return r[e]=i,n},r[e]=n}}("Expressify",function(e,t){return{Client:e,Server:t}});